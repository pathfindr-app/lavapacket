<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAVA Roofing Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase config -->
    <meta name="supabase-url" content="https://bdfmlnujqattlrbydbzr.supabase.co">
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkZm1sbnVqcWF0dGxyYnlkYnpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3Njk3MDQsImV4cCI6MjA4NDM0NTcwNH0.zTT30k9R_Fd_koscvAGsu5GvF_puUSH7W9xOpaSLBNc">
    <link rel="stylesheet" href="css/portal.css">
</head>
<body>
    <!-- Password Screen -->
    <div class="password-screen" id="passwordScreen">
        <div class="password-box">
            <img src="assets/images/logo.png" alt="LAVA" class="password-logo">
            <div class="password-title">Employee Portal</div>
            <input type="password" class="password-input" id="passwordInput" placeholder="Enter password">
            <div class="password-error" id="passwordError">Incorrect password</div>
            <button class="password-btn" id="unlockBtn">Unlock</button>
        </div>
    </div>

    <!-- Portal Header -->
    <header class="portal-header">
        <div class="portal-header-inner">
            <img src="assets/images/logo.png" alt="LAVA" class="portal-logo">
            <nav class="portal-nav">
                <a href="index.html" class="portal-nav-btn active">Dashboard</a>
                <a href="packets/index.html" class="portal-nav-btn">Packets</a>
                <a href="inspections/index.html" class="portal-nav-btn">Inspections</a>
                <a href="media/index.html" class="portal-nav-btn">Media</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="portal-main">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Welcome to the LAVA Roofing employee portal</p>

        <!-- Stats -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="statPackets">-</div>
                <div class="stat-label">Total Packets</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statInspections">-</div>
                <div class="stat-label">Total Inspections</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statWeek">-</div>
                <div class="stat-label">Created This Week</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="section-header">
            <h2 class="section-title">Quick Actions</h2>
        </div>
        <div class="quick-actions">
            <a href="packets/builder.html" class="action-card">
                <div class="action-icon blue">üì¶</div>
                <div>
                    <div class="action-title">New Packet</div>
                    <div class="action-desc">Create a customer estimate packet</div>
                </div>
            </a>
            <a href="inspections/form.html" class="action-card">
                <div class="action-icon orange">üîç</div>
                <div>
                    <div class="action-title">New Inspection</div>
                    <div class="action-desc">Start a roof inspection report</div>
                </div>
            </a>
            <a href="repairs/estimate.html" class="action-card">
                <div class="action-icon red">üîß</div>
                <div>
                    <div class="action-title">Repair Estimate</div>
                    <div class="action-desc">Quick pricing for small repair jobs</div>
                </div>
            </a>
            <a href="packets/index.html" class="action-card">
                <div class="action-icon green">üìã</div>
                <div>
                    <div class="action-title">View All</div>
                    <div class="action-desc">Browse existing packets and inspections</div>
                </div>
            </a>
        </div>

        <!-- Recent Activity -->
        <div class="section-header">
            <h2 class="section-title">Recent Activity</h2>
            <a href="packets/index.html" class="section-link">View all</a>
        </div>
        <div class="item-list" id="recentActivity">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading recent activity...
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Scripts -->
    <script src="js/lib/supabase.js"></script>
    <script src="js/modules/auth.js"></script>

    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Supabase
            SupabaseClient.init();

            // Initialize auth
            Auth.init();

            // Load data after auth
            document.addEventListener('auth:unlocked', loadDashboard);

            // If already authenticated, load immediately
            if (Auth.isAuthenticated()) {
                loadDashboard();
            }
        });

        async function loadDashboard() {
            // Load stats
            loadStats();

            // Load recent activity
            loadRecentActivity();
        }

        async function loadStats() {
            const stats = await SupabaseClient.getDashboardStats();

            document.getElementById('statPackets').textContent = stats.totalPackets;
            document.getElementById('statInspections').textContent = stats.totalInspections;
            document.getElementById('statWeek').textContent = stats.thisWeek;
        }

        async function loadRecentActivity() {
            const container = document.getElementById('recentActivity');

            if (SupabaseClient.isAvailable()) {
                const items = await SupabaseClient.getRecentActivity(5);

                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-title">No recent activity</div>
                            <div class="empty-text">Create a packet or inspection to get started</div>
                            <a href="packets/builder.html" class="btn btn-primary">Create Packet</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = items.map(item => `
                    <a href="${item.type === 'packet' ? 'packets/builder.html' : 'inspections/form.html'}?id=${item.id}" class="item-card">
                        <div class="item-info">
                            <div class="item-name">${item.customer_name || 'Unnamed'}</div>
                            <div class="item-meta">
                                <span>${item.customer_address || 'No address'}</span>
                                <span>${formatDate(item.updated_at)}</span>
                            </div>
                        </div>
                        <span class="item-badge ${item.type}">${item.type}</span>
                    </a>
                `).join('');
            } else {
                // Load from localStorage
                loadLocalActivity(container);
            }
        }

        function loadLocalActivity(container) {
            const packets = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('lavaPacketBuilder_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        packets.push({
                            id: key.replace('lavaPacketBuilder_', ''),
                            customer_name: data.customer_name || data.fields?.customerName || 'Unnamed',
                            customer_address: data.customer_address || data.fields?.customerAddress || '',
                            updated_at: data.timestamp ? new Date(data.timestamp).toISOString() : new Date().toISOString(),
                            type: 'packet'
                        });
                    } catch (e) {}
                }
            }

            packets.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

            if (packets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-title">No recent activity</div>
                        <div class="empty-text">Create a packet or inspection to get started</div>
                        <a href="packets/builder.html" class="btn btn-primary">Create Packet</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = packets.slice(0, 5).map(item => `
                <a href="packets/builder.html?id=${item.id}" class="item-card">
                    <div class="item-info">
                        <div class="item-name">${item.customer_name}</div>
                        <div class="item-meta">
                            <span>${item.customer_address || 'No address'}</span>
                            <span>${formatDate(item.updated_at)}</span>
                        </div>
                    </div>
                    <span class="item-badge packet">packet</span>
                </a>
            `).join('');

            // Update stats with local count
            document.getElementById('statPackets').textContent = packets.length;
            document.getElementById('statInspections').textContent = '0';

            const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const thisWeek = packets.filter(p => new Date(p.updated_at).getTime() > weekAgo).length;
            document.getElementById('statWeek').textContent = thisWeek;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} min ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} hr ago`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)} days ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
    </script>
</body>
</html>
